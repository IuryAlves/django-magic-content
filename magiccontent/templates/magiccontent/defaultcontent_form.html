{% extends 'magiccontent/base_magiccontent.html' %}

{% load staticfiles %}
{% load floppyforms %}
{% load cropping %}
{% load thumbnail %}

{% block extracss %}
<link href="{% static 'gallery/css/gallery.css' %}" rel="stylesheet" media="screen">
{% endblock %}

{% block js_top %}
    <!-- # django-floppyforms -->
    {{ block.super }}
    {{ form.media }}
{% endblock %}

{% block content %}

<div class="popup-content">

       
    <div class="row">
        <div class="col-sm-2">

          {% block quick_navigation %}
          {% comment %}
          <!-- enables only for update form -->
          {% endcomment %}
          {% if save_btn_label != 'continue' and not view.show_picture_fields %}
          <div class="side-fix-menus">
            <ul class="nav nav-pills nav-stacked" id="nav-elements">
              <li role="presentation" class="active">
                <a href="#" id="goto-title">Title<br/><i class="fa fa-minus"></i></a>
              </li>
              
              <li role="presentation">
                <a href="#" id="goto-content">Content<br/><i class="fa fa-file-text-o"></i></a>
              </li>
              {% if form.show_link_tools %}
              <li role="presentation">
                <a href="#" id="goto-link">Link<br/><i class="fa fa-external-link"></i></a>
              </li>
              {% endif %}
            </ul>
          </div>
          {% endif %}
          {% endblock quick_navigation %}

        </div>

        <div class="col-sm-9">
            {% if not object %}
            <h1>Creating a new {{ widget.name }} content <small>({{ widget.description }})</small>:</h1>
            {% else %}
            <h1>{{ object.widget.name }} <small>({{ object.widget.description }})</small></h1>
            {% endif %}
            <form method='post' enctype="multipart/form-data" id="simpleContentForm" action="{{ request.path }}">{% csrf_token %}

                {{ form }}

                {% if save_btn_label != 'continue' and form.show_link_tools %}
                <div class="col-lg-8" style="margin-top: 20px;" id="linkControl">
                  <h4>Apply a link to this content</h4>
                  <a href="#" class="btn btn-sm" id="linkSelect">
                    <i class="fa fa-link" style="font-size: 26px;"></i>
                    <br />
                    Select an existing link from this site
                  </a>
                  <span>OR</span>
                  <a href="#" class="btn btn-sm" id="newLink">
                    <i class="fa fa-external-link" style="font-size: 26px;"></i>
                    <br />
                    Create a new external link
                  </a>
                </div>
                {% endif %}

                <div class="bottom-fix-menu" align="center">
                  <h1>
                    <a class="btn pull-left" href="{% url 'magiccontent.widget.update' widget.id %}">&nbsp &nbsp <i class="fa fa-star-half-o" style="font-size: 22px; color: #777"></i></a>

                    <input type="submit" class="btn btn-lg btn-success" value="{{ save_btn_label.title }}" />
                    <a href="{% url 'magiccontent.windows_close' %}?dont_reload=1" class="btn btn-lg btn-danger" role="button" >Cancel</a>
                    {% if object and object.allow_delete %}
                    <a href="{{ object.delete_url }}" class="btn btn-lg btn-danger del-content" role="button">Delete</a>
                    {% endif %}

                    <small><i class="fa fa-columns"></i> {{ object.widget.widget_type }}</small>
                  </h1>
                </div>

                {% if object.picture %}
                  <input type="hidden" value="picture" id="picture_found" />
                {% endif %}

            </form> 

            {% comment %}Gallery Controls should appears only in object update{% endcomment %}
            {% if object and object.enable_picture and view.show_picture_fields %}
            
            <p>&nbsp;</p>
            <span><br/><br/></span>
            <a name="goto-image" id="id-goto-image"></a>

            <div class="col-lg-8" style="margin-bottom: 15px" id="galleryControls">
              <a href="#" class="action-upload btn btn-default btn-sm"><i class="fa fa-cloud-download" style="font-size: 26px;"></i><br/>Upload an image</a> <b>OR</b> 
              <a href="#" class="action-gallery btn btn-default btn-sm"><i class="fa fa-image" style="font-size: 26px;"></i><br/>Pick from a gallery</a>
            </div>

            <div class="col-lg-8">
              <form method='post' enctype="multipart/form-data" id="dropzoneForm" class="dropzone"
                action="{% url 'galleries.item.create_by_gallery' default_gallery.pk %}?return_id=1"
                style="border: 3px dashed rgba(144,144,144,.99); display:none;">
                {% csrf_token %}
                <center>
                  <img src="{% static 'frontend/themes/sydney/img/dragndrop-image.png' %}" class="my1 py2">
                  <h3>Drag an image here</h3>                  
                </center>

                <input type="file" name="picture" style="display: none;" form="dropzoneForm" />

              </form>
            </div>

            <div id="galleryChoice">
              {% regroup all_images by gallery as gallery_list %}

              {% for gallery_item in gallery_list %}
              <div>
                <h3>{{ gallery_item.grouper }} <small>Click for apply the image</small></h3>
                <ul>
                  {% for item in gallery_item.list %}
                    <li class="img-effects img-effects-darker clearfix">                  
                      <figure>
                        <img src="{% thumbnail item.picture 142x96 crop %}">
                        <div class="mouseenter">
                          <a href="#" class="apply-img" data-img-choice-id="{{ item.pk }}"><i class="fa fa-check-square-o"></i></a>
                        </div>
                      </figure>
                    </li>
                  {% endfor %}
                </ul>
              </div>
              {% endfor %}
            </div>
            <span><br/><br/><br/><br/></span>
            {% endif %}

            <p>&nbsp;</p>
            <span><br/><br/><br/><br/><br/><br/><br/><br/><br/></span>
            <p>&nbsp;</p>

        </div>
    </div>
</div>

{% endblock %}


{% block extrajs %}

  <script type="text/javascript">

     ajaxSubmit = function(){
         var form = $('#simpleContentForm');
         var formData = form.serialize();
         $.ajax({
          url: form.attr('action'),
          type: 'POST',
          data: formData,
          success: function(response){
            var redirectTo = form.attr('action') + '#galleryControls';
            console.log(redirectTo);
            window.location.href = redirectTo;
            window.location.reload(true);
          }
        });       
      };


    Dropzone.options.dropzoneForm = {
      paramName: 'picture',
      acceptedFiles: 'image/*',
      maxFiles: 1,
      init: function() {
        this.on("addedfile", function(file){
          var fileSize = file.size;
          var maxSize = 5242880; // 5MB in bytes
          if (fileSize > maxSize){
            alert('the file is too big, the max allowed size is 5MB.');
            this.removeFile(file);
          }
        });

        this.on("success", function(picture, response){
          $('#id_picture').attr('value', response);
          if (response.length < 200){
            ajaxSubmit();
          }else{
            alert("invalid file, it wasn't uploaded");
            this.removeFile(file);
          }
        });
      }
    };

    $(function(){
      // hide default django form widget (cant do in back-end)
      $('#lookup_id_picture').closest('.form-group').hide();

      $('.action-upload').on('click', function(evt){
        evt.preventDefault();
        $('#galleryChoice').hide();
        $('#dropzoneForm').fadeIn();
      });

      $('.action-gallery').on('click', function(evt){
        evt.preventDefault();
        $('#dropzoneForm').hide();
        $('#galleryChoice').fadeIn();
      });

      $('.apply-img').on('click', function(evt){
        evt.preventDefault();
        var self = $(this);
        self.css('border-color', 'green');
        $('#id_picture').attr('value', self.attr('data-img-choice-id'));
        ajaxSubmit();
      });

    });

    // hide the picture filters when there is no picture
    $(document).ready(function(){
      $("#id_picture_filter").hide();
      $("label[for='id_picture_filter']").hide();
      if ( $('#picture_found').val() ) {
        $("#btn_id_picture_filter").on('click', function(evt){
          evt.preventDefault();
          $("#id_picture_filter").toggle();
        });
      }

      // confirm content deletation
      $('a.del-content').on('click', function(evt){
        evt.preventDefault();
        var deleteIt = confirm('are you sure that you want to delete this item?');
        if (deleteIt == true){
          window.location.href = $(this).attr('href');
        }

      });


      // links control
      var formFieldDisplay = function(fieldId, action){
        var selector = $('#' + fieldId).closest('.form-group');

        if (action === 'hide'){
          selector.hide();
        }else if (action === 'show'){
          selector.slideDown();
        }
      }
      if (!$('#id_site_link').val()){
        formFieldDisplay('id_site_link', 'hide');
        formFieldDisplay('id_link_label', 'hide');
      }else{
        $('#linkControl h4').hide();
        $('#linkControl span').hide();
        $('#linkSelect').hide();
      }
      formFieldDisplay('id_custom_link_url', 'hide');

      $('#linkSelect').on('click', function(evt){
        evt.preventDefault();
        formFieldDisplay('id_custom_link_url', 'hide');
        formFieldDisplay('id_site_link', 'show');
        formFieldDisplay('id_link_label', 'show');
      });
      $('#newLink').on('click', function(evt){
        evt.preventDefault();
        $('#linkControl span').show();
        $('#linkSelect').show();
        formFieldDisplay('id_site_link', 'hide');
        formFieldDisplay('id_link_label', 'show');
        formFieldDisplay('id_custom_link_url', 'show');
      });


      // handle the mouseenter functionality
      $(".img-effects > figure")
        .mouseenter(function(){
          $(this).addClass("hover");})
        .mouseleave(function(){
          $(this).removeClass("hover");
      });

      $('#nav-elements a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
      });
      $("#goto-title").on('click', function(evt){
        evt.preventDefault();
        $('html,body').animate({scrollTop: $("label[for='id_title']").offset().top});
      });
      $("#goto-content").on('click', function(evt){
        evt.preventDefault();
        if ( $( "#id_long_content" ).length ) {
          $('html,body').animate({scrollTop: $("label[for='id_long_content']").offset().top});
        } else {
          $('html,body').animate({scrollTop: $("label[for='id_short_content']").offset().top});
        }
      });
      $("#goto-image").on('click', function(evt){
        evt.preventDefault();
        $('html,body').animate({scrollTop: $("#id-goto-image").offset().top});
      });
      $("#goto-link").on('click', function(evt){
        evt.preventDefault();
        $('html,body').animate({scrollTop: $("#newLink").offset().top});
      });

    });

  </script>

{% endblock extrajs %}
